generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  TALENT
  EMPLOYER
  MODERATOR
}

enum JobType {
  FULL_TIME
  PART_TIME
  INTERNSHIP
}

enum ExperienceLevel {
  FRESH
  JUNIOR
  SENIOR
  LEAD
}

enum ApplicationStatus {
  APPLIED
  REJECTED
  HIRED
}

enum LanguageProficiency {
  BASIC
  INTERMEDIATE
  ADVANCED
  NATIVE
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
  MASTER
}

model User {
  id       String  @id // ULID generated by app
  email    String  @unique
  password String
  isActive Boolean @default(true)
  role     Role

  // Relations to role-specific profiles
  talentProfile   Talent?
  employerProfile Employer?

  // Tokens
  refreshTokens         RefreshToken[] @relation("UserRefreshTokens")
  isEmailVerified       Boolean        @default(false)
  verificationToken     String?
  verificationExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([role])
}

model RefreshToken {
  id           String    @id // ULID generated by app
  token        String    @unique
  userId       String
  user         User      @relation("UserRefreshTokens", fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime  @default(now())
  expiresAt    DateTime
  revoked      Boolean   @default(false)
  revokedAt    DateTime?
  replacedById String?

  // optional self-relation to chain replacements
  replacedBy     RefreshToken?  @relation("TokenReplacement", fields: [replacedById], references: [id], onDelete: SetNull)
  replacedTokens RefreshToken[] @relation("TokenReplacement")

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Talent {
  id     String @id // ULID generated by app (same as User.id)
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName      String?
  lastName       String?
  headline       String?
  bio            String? @db.VarChar(1000)
  location       String?
  avatarPublicId String?
  resumePublicId String?

  // Relations
  skills       TalentSkill[]       @relation("TalentSkills")
  languages    TalentLanguage[]    @relation("TalentLanguages")
  certificates TalentCertificate[]
  applications Application[]       @relation("TalentApplications")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Employer {
  id     String @id // ULID generated by app (same as User.id)
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  companyName    String
  website        String?
  description    String? @db.VarChar(1000)
  location       String?
  avatarPublicId String?

  // Relations
  jobs Job[] @relation("EmployerJobs")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([companyName])
}

model Job {
  id         String   @id // ULID generated by app
  employerId String
  employer   Employer @relation("EmployerJobs", fields: [employerId], references: [id], onDelete: Cascade)

  title            String
  description      String          @db.Text
  responsibilities String[]        @default([]) // Array of responsibility strings
  location         String?
  jobType          JobType
  experienceLevel  ExperienceLevel
  hoursPerWeek     Int?
  salary           Int?
  publishedAt      DateTime        @default(now())

  // Relations
  requiredSkills    JobSkill[]    @relation("JobRequiredSkills")
  requiredLanguages JobLanguage[] @relation("JobRequiredLanguages")
  applications      Application[] @relation("JobApplications")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employerId])
  @@index([jobType])
  @@index([experienceLevel])
}

model JobSkill {
  id       String  @id // ULID generated by app
  jobId    String
  skillId  String
  required Boolean @default(true) // true = required, false = nice to have

  job   Job   @relation("JobRequiredSkills", fields: [jobId], references: [id], onDelete: Cascade)
  skill Skill @relation("JobSkills", fields: [skillId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([jobId, skillId])
  @@index([skillId])
}

model JobLanguage {
  id                 String              @id // ULID generated by app
  jobId              String
  languageId         String
  minimumProficiency LanguageProficiency // Minimum required proficiency level
  required           Boolean             @default(true)

  job      Job      @relation("JobRequiredLanguages", fields: [jobId], references: [id], onDelete: Cascade)
  language Language @relation("JobLanguages", fields: [languageId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([jobId, languageId])
  @@index([languageId])
}

model Application {
  id       String @id // ULID generated by app
  jobId    String
  job      Job    @relation("JobApplications", fields: [jobId], references: [id], onDelete: Cascade)
  talentId String
  talent   Talent @relation("TalentApplications", fields: [talentId], references: [id], onDelete: Cascade)

  coverLetter String?           @db.Text
  resumeUrl   String?
  status      ApplicationStatus @default(APPLIED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([jobId, talentId])
  @@index([talentId])
  @@index([jobId])
}

model Skill {
  id        String   @id // ULID generated by app
  name      String   @unique
  createdAt DateTime @default(now())

  talents TalentSkill[] @relation("SkillTalents")
  jobs    JobSkill[]    @relation("JobSkills")
}

model TalentSkill {
  id        String     @id // ULID generated by app
  talentId  String
  skillId   String
  level     SkillLevel
  createdAt DateTime   @default(now())

  talent Talent @relation("TalentSkills", fields: [talentId], references: [id], onDelete: Cascade)
  skill  Skill  @relation("SkillTalents", fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([talentId, skillId])
  @@index([skillId])
}

model Language {
  id        String   @id // ULID generated by app
  name      String   @unique
  createdAt DateTime @default(now())

  talents TalentLanguage[] @relation("TalentLanguages")
  jobs    JobLanguage[]    @relation("JobLanguages")
}

model TalentLanguage {
  id          String              @id // ULID generated by app
  talentId    String
  languageId  String
  proficiency LanguageProficiency
  createdAt   DateTime            @default(now())

  talent   Talent   @relation("TalentLanguages", fields: [talentId], references: [id], onDelete: Cascade)
  language Language @relation("TalentLanguages", fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([talentId, languageId])
  @@index([languageId])
}

model TalentCertificate {
  id            String    @id // ULID generated by app
  talentId      String
  name          String
  issuer        String
  credentialUrl String?
  credentialId  String?
  issueDate     DateTime?
  expiryDate    DateTime?
  createdAt     DateTime  @default(now())

  talent Talent @relation(fields: [talentId], references: [id], onDelete: Cascade)

  @@index([talentId])
}
